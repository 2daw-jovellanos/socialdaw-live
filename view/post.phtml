<?php
global $URL_PATH;
\dawfony\Ti::extend("view/mainview.phtml");
\dawfony\Ti::startBlock("content");
function convertYoutube($string)
{
    return preg_replace(
        "/\s*[a-zA-Z\/\/:\.]*youtu(be.com\/watch\?v=|.be\/)([a-zA-Z0-9\-_]+)([a-zA-Z0-9\/\*\-\_\?\&\;\%\=\.]*)/i",
        "<style>.embed-container { position: relative; padding-bottom: 56.25%; height: 0; overflow: hidden; max-width: 100%; } .embed-container iframe, .embed-container object, .embed-container embed { position: absolute; top: 0; left: 0; width: 100%; height: 100%; }</style><div class='embed-container'><iframe src='https://www.youtube.com/embed/$2' frameborder='0' allowfullscreen></iframe></div>",
        $string
    );
}
?>

<div class="row m-2">
    <div class="col-5">
        <img class="img-fluid rounded" src="<?= $URL_PATH ?>/assets/foto/<?= $post->foto ?>" alt="Imagen: <?= $post->resumen ?>">
    </div>
    <div class="col-7">
        <h4><?= $post->resumen ?></h4>
        <?php /*Pasamos el id del post al evento de javascript. Enlace solo si usuario logueado*/ ?>
        <?php if (isset($_SESSION["login"])) : ?>
            <a href="javascript:void(0)" onclick="likeClicked(<?= $post->id ?>)">
            <?php endif ?>
            <?php /* El atributo id del elemento del corazón tiene como sufijo el id del post */ ?>
            <i id="likecorazon<?= $post->id ?>" class="fa fa-heart<?= ($post->like ? " text-danger" : "") ?>"></i>
            <?php if (isset($_SESSION["login"])) : ?>
            </a>
        <?php endif ?>
        <?php /* Lo mismo para el elemento que contiene la cuenta de likes:
                             su atributo id contiene como sufijo el id del post */ ?>
        <span id="likecontador<?= $post->id ?>">
            <?= $post->numLikes ?>
        </span>
        <a href="#comentarios"><i class="fa fa-comments"></i> <?= $post->numComments ?></a>
        <div>
            Por <a href="<?= $URL_PATH ?>/perfil/<?= $post->usuario_login ?>"><?= $post->usuario_login ?></a>
            en <em><?= $post->categoria ?></em>
            el <?= $post->fecha ?>
        </div>
    </div>
</div>
<div class="container">
    <?= convertYoutube($post->texto) ?>
</div>
<hr>
<?php if (isset($_SESSION["login"])) : ?>
    <?php $placeholder = ($post->numComments == 0 ? "Sé el primero en comentar" : "Escribe aquí tu comentario") ?>
    <h4 id="comentarios">Comentarios</h4>
    <form method="POST" action="<?= $URL_PATH ?>/post/<?= $post->id ?>/comentario/new">
        <div class="form-group row">
            <div class="col-sm-8">
                <textarea placeholder="<?= $placeholder ?>" class="form-control" rows="2" name="texto" id="texto"></textarea>
            </div>
            <div class="col-sm-4">
                <button type="submit" class="btn btn-success">Comentar</button>
            </div>
        </div>
    </form>
<?php else : ?>
    <div class="alert alert-info">
        Inicia sesión para comentar
        <button type="button" class="close" data-dismiss="alert" aria-label="Close">
            <span aria-hidden="true">&times;</span>
        </button>
    </div>
<?php endif ?>
<?php foreach ($post->comentarios as $comentario) : ?>
    <div class="row border-top border-rounded">
        <div class="col-sm-8">
            <?= $comentario->texto ?>
        </div>
        <col-sm-4>
            Por <a href="<?= $URL_PATH ?>/perfil/<?= $post->usuario_login ?>"><?= $comentario->usuario_login ?></a> el <?= $comentario->fecha ?>
        </col-sm-4>
    </div>
<?php endforeach; ?>
<script src="<?= $URL_PATH ?>/js/like.js"></script>
<?php
\dawfony\Ti::endBlock();
\dawfony\Ti::endExtend();
?>